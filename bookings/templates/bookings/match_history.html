{% extends "base.html" %}

{% block title %}Match History{% endblock %}

{% block content %}
<h1>Match History</h1>

<!-- Debugging Information -->
<div>
    <h3>Debugging Information</h3>
    <p>Logged-in User ID: {{ user.id }}</p>
    <p>Logged-in Username: {{ user.username }}</p>
</div>

{% if match_history %}
    <table class="match-history-table">
        <thead>
            <tr>
                <th>Match ID</th>
                <th>Match Name</th>
                <th>Activity</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Match Creator</th>
                <th>Opponent</th>
                <th>Your Role</th> <!-- New column for role -->
                <th>Your Result</th>
                <th>Opponent's Result</th>
                <th>Action</th>
                <th>Debug Info</th>
            </tr>
        </thead>
        <tbody>
            {% for match in match_history %}
            <tr>
                <td>{{ match.id }}</td>
                <td>{{ match.name }}</td>
                <td>{{ match.booking_type|title }}</td>
                <td>{{ match.start_time|date:"M d, Y H:i" }}</td>
                <td>{{ match.end_time|date:"M d, Y H:i" }}</td>
                <td>{{ match.user_id }}</td> <!-- Match creator's user_id -->
                <td>
                    {% if match.opponent %}
                        {{ match.opponent.username }}
                    {% else %}
                        No opponent
                    {% endif %}
                </td>
                <td>
                    <!-- Determine the role of the logged-in user -->
                    {% if match.user_id == user.id|stringformat:"s" %}
                        Match Creator
                    {% elif match.opponent and match.opponent.id == user.id %}
                        Opponent
                    {% else %}
                        Unknown
                    {% endif %}
                </td>
                <td>
                    {% if match.user_id == user.id|stringformat:"s" %}
                        <!-- Your Result as Match Creator -->
                        {% if match.user_result == 'win' %}
                            Won
                        {% elif match.user_result == 'loss' %}
                            Lost
                        {% else %}
                            Pending
                        {% endif %}
                    {% elif match.opponent and match.opponent.id == user.id %}
                        <!-- Your Result as Opponent -->
                        {% if match.opponent_result == 'win' %}
                            Won
                        {% elif match.opponent_result == 'loss' %}
                            Lost
                        {% else %}
                            Pending
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if match.user_id == user.id|stringformat:"s" %}
                        <!-- Opponent's Result as Match Creator -->
                        {% if match.opponent_result == 'win' %}
                            Won
                        {% elif match.opponent_result == 'loss' %}
                            Lost
                        {% else %}
                            Pending
                        {% endif %}
                    {% elif match.opponent and match.opponent.id == user.id %}
                        <!-- Opponent's Result as Opponent -->
                        {% if match.user_result == 'win' %}
                            Won
                        {% elif match.user_result == 'loss' %}
                            Lost
                        {% else %}
                            Pending
                        {% endif %}
                    {% endif %}
                </td>
                <td> {# Action Column #}
                    {# Condition 1: Check if user is creator #}
                    {% if match.user_id == user.id|stringformat:"s" %}
                        {# THEN check if creator's result is pending #}
                        {% if match.user_result == 'pending' or match.user_result is None %}
                            <button class="action-button win-button" onclick="confirmResult('{{ match.id }}', 'win')">I Won</button>
                            <button class="action-button loss-button" onclick="confirmResult('{{ match.id }}', 'loss')">I Lost</button>
                        {% else %}
                            {# Optionally show something if result submitted but opponent hasn't #}
                            -
                        {% endif %}
    
                    {# Condition 2: Check if user is opponent #}
                    {% elif match.opponent and match.opponent.id == user.id %}
                        {# THEN check if opponent's result is pending #}
                        {% if match.opponent_result == 'pending' or match.opponent_result is None %}
                            <button class="action-button win-button" onclick="confirmResult('{{ match.id }}', 'win')">I Won</button>
                            <button class="action-button loss-button" onclick="confirmResult('{{ match.id }}', 'loss')">I Lost</button>
                        {% else %}
                             {# Optionally show something if result submitted but opponent hasn't #}
                             -
                        {% endif %}
    
                    {# Fallback if user is neither participant or results are final #}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <td>
                    <!-- Debugging Information for Each Match -->
                    <p>Match Creator ID: {{ match.user_id }}</p>
                    <p>Opponent ID: {% if match.opponent %}{{ match.opponent.id }}{% else %}No opponent{% endif %}</p>
                    <p>User Result: {{ match.user_result }}</p>
                    <p>Opponent Result: {{ match.opponent_result }}</p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No match history available.</p>
{% endif %}

<script>
function confirmResult(matchId, result) {
    fetch(`/confirm-result/${matchId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ result: result })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        location.reload(); // Reload the page to reflect the updated results
    })
    .catch(error => console.error("Error:", error));
}
</script>

<style>
/* Match History Table */
/* In styles.css */


.match-history-table th, .match-history-table td {
    border: 1px solid #ddd;
    padding: 8px;
}

.match-history-table th {
    background-color: #f4f4f4;
    font-weight: bold;
}

.match-history-table tr:nth-child(even) {
    background-color: #f9f9f9;
}

.match-history-table tr:hover {
    background-color: #f1f1f1;
}

/* Buttons */
.action-button {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    color: #fff;
}

.win-button {
    background-color: #4CAF50; /* Green */
}

.win-button:hover {
    background-color: #45a049;
}

.loss-button {
    background-color: #f44336; /* Red */
}

.loss-button:hover {
    background-color: #e53935;
}
</style>
{% endblock %}