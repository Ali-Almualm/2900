{# bookings/templates/bookings/match_availability.html #}

{% extends "base.html" %}
{% load static custom_filters %}

{% block content %}
<h1>{{ activity_type|title }} Match Availability</h1>

{% if error %}
<div class="error-message">{{ error }}</div>
{% endif %}

{# Combined Grid #}
<h3>Click to Select Available Times (08:00 - 23:45)</h3>
<p>Green slots indicate your current availability. Click any slot between 08:00 and midnight to automatically add or remove your availability for that specific time.</p>

<div class="time-selector">
    {% csrf_token %} {# <--- ADD THIS LINE HERE #}
    <label for="selected-date">Date:</label>
    <input type="date" id="selected-date" value="{{ selected_date|date:'Y-m-d' }}">

    <div class="time-grid">
        {# Grid generation loop remains the same #}
        {% for hour in '8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23'|split:',' %}
            {% for minute in '00,15,30,45'|split:',' %}
                {% with slot_time_str=hour|stringformat:"02s"|add:":"|add:minute %}
                <div
                    class="time-slot{% if slot_time_str in existing_availability_times %} selected-slot{% endif %}"
                    data-time="{{ slot_time_str }}">
                    {{ slot_time_str }}
                </div>
                {% endwith %}
            {% endfor %}
        {% endfor %}
    </div>
    {# Save button removed #}
</div>

{# --- JavaScript Block (Keep as is from previous step) --- #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const timeGrid = document.querySelector('.time-grid');
    // Ensure this query selector works now that {% csrf_token %} is added
    const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;

    if (!csrfToken) {
        console.error("CSRF Token input field not found! Automatic saving will fail.");
        // Optionally alert the user or disable clicking
    }

    if (timeGrid && csrfToken) { // Only add listener if grid and token are found
        console.log("Time grid and CSRF token found. Adding auto-save click listener.");
        timeGrid.addEventListener('click', function(event) {
            const clickedSlot = event.target.closest('.time-slot');
            if (clickedSlot) {
                clickedSlot.classList.toggle('selected-slot');
                const isNowSelected = clickedSlot.classList.contains('selected-slot');
                const timeStr = clickedSlot.dataset.time;
                const selectedDate = document.getElementById('selected-date').value;
                const activityType = "{{ activity_type }}";

                console.log(`Sending update: Slot ${timeStr}, Date ${selectedDate}, Activity ${activityType}, Selected: ${isNowSelected}`);

                clickedSlot.style.opacity = '0.6';

                fetch("{% url 'toggle_slot_availability' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken // Use the found token
                    },
                    body: JSON.stringify({
                        time_slot: timeStr,
                        selected_date: selectedDate,
                        activity_type: activityType,
                        is_selected: isNowSelected
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => { throw new Error(errData.message || `Server error: ${response.status}`); })
                           .catch(() => { throw new Error(`Server error: ${response.status} ${response.statusText}`); });
                    }
                    console.log(`Slot ${timeStr} update successful.`);
                    return null;
                })
                .catch(error => {
                    console.error("Error updating single slot:", error);
                    alert(`Failed to save change for ${timeStr}: ${error.message}`);
                    clickedSlot.classList.toggle('selected-slot'); // Revert visual state
                })
                .finally(() => {
                     clickedSlot.style.opacity = '1';
                });
            }
        });
    } else if (!timeGrid) {
        console.error("ERROR: Time grid element (.time-grid) not found!");
    }
    // Date Filter Function remains the same
    const dateInput = document.getElementById('selected-date');
    if(dateInput) {
        dateInput.addEventListener('change', function() {
            const selectedDateValue = this.value;
             window.location.href = `{% url 'match_availability' activity_type=activity_type %}?date=${selectedDateValue}`;
        });
    }
});
</script>

<style>
/* Styles for the time grid and selection (Keep as is) */
.time-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 5px;
    margin: 20px 0;
    max-width: 600px; /* Adjust width as needed */
}

.time-slot {
    padding: 8px 5px;
    text-align: center;
    border: 1px solid #ddd;
    cursor: pointer;
    background-color: #f9f9f9;
    font-size: 0.9em;
    border-radius: 3px;
    transition: background-color 0.2s ease, border-color 0.2s ease, opacity 0.3s ease; /* Added opacity transition */
    user-select: none;
}

.time-slot:hover {
    background-color: #e9f7ff;
    border-color: #aedcff;
}

.time-slot.selected-slot {
    background-color: #d4edda; /* Light green */
    border-color: #c3e6cb;
    color: #155724;
    font-weight: bold;
}

/* Other necessary styles */
.error-message {
    color: red;
    padding: 10px;
    margin: 10px 0;
    background-color: #ffeeee;
    border: 1px solid #ffcccc;
    border-radius: 4px;
}

.time-selector { /* Container for date input and grid */
    margin: 15px 0;
}
.time-selector label {
    margin-right: 5px;
    font-weight: bold;
}
.time-selector input[type="date"] {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-right: 10px; /* Space between date and grid */
}

/* No need for #update-availability button styles */

</style>
{% endblock %}