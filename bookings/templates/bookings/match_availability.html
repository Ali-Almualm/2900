{% extends "base.html" %}
{% load static custom_filters %}

{% block content %}
{# Changed Title #}
<h1>{{ activity_type|title }} Match Availability</h1>

{% if error %}
<div class="error-message">{{ error }}</div>
{% endif %}

{# Changed form action URL name #}
<form method="POST" action="{% url 'save_match_availability' activity_type=activity_type %}">
    {% csrf_token %}
    <div class="form-group">
        <label for="booking_type">Booking Type:</label>
        <select name="booking_type" id="booking_type" disabled>
            <option value="pool" {% if activity_type == 'pool' %}selected{% endif %}>Pool</option>
            <option value="switch" {% if activity_type == 'switch' %}selected{% endif %}>Nintendo Switch</option>
            <option value="table_tennis" {% if activity_type == 'table_tennis' %}selected{% endif %}>Table Tennis</option>
        </select>
        <input type="hidden" name="booking_type" value="{{ activity_type }}">
    </div>
    <div class="form-group">
        <label for="start_time">Start Time:</label>
        <input type="datetime-local" name="start_time" id="start_time" required>
    </div>
    <div class="form-group">
        <label for="end_time">End Time:</label>
        <input type="datetime-local" name="end_time" id="end_time" required>
    </div>
    <div class="form-group">
        {# Clarified label text #}
        <label for="is_available">Is Available for Matches:</label>
        <input type="checkbox" name="is_available" id="is_available" checked>
    </div>
    {# Changed button text #}
    <button type="submit">Add New Match Availability</button>
</form>

{# Changed heading text #}
<h2>Your Current Match Availability</h2>
<div class="date-selector">
    {# Changed label text #}
    <label for="availability-date">View match availability for date:</label>
    <input type="date" id="availability-date" value="{{ selected_date|default:today|date:'Y-m-d' }}">
    {# Changed onclick function name #}
    <button onclick="filterMatchAvailabilityByDate()">Filter</button>
</div>

<table class="timetable">
    <thead>
        <tr>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="availability-slots">
        {# Changed loop variable #}
        {% for availability in match_availabilities %}
        {# Changed data attribute name for consistency, though not strictly required #}
        <tr class="selectable" data-id="{{ availability.id }}" data-match-availability-id="{{ availability.id }}">
            <td>{{ availability.start_time }}</td>
            <td>{{ availability.end_time }}</td>
            <td>{{ availability.is_available|yesno:"Available for Match,Not Available" }}</td>
            <td>
                {# Changed onclick function names and parameter #}
                <button onclick="toggleMatchAvailability({{ availability.id }}, {{ availability.is_available|yesno:'true,false' }})">
                    {{ availability.is_available|yesno:"Mark Unavailable,Mark Available" }}
                </button>
                {# Changed onclick function name and parameter #}
                <button onclick="deleteMatchAvailability({{ availability.id }})">Delete</button>
            </td>
        </tr>
        {% empty %}
        <tr>
            {# Changed empty message text #}
            <td colspan="4">No match availability set for this activity on this date.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{# Optional: Calendar view remains conceptually the same #}
<div class="calendar-view">
    <h3>Calendar View</h3>
    <div class="calendar-grid">
        </div>
</div>

{# Changed heading and paragraph text #}
<h3>Drag to Select Match Available Time</h3>
<p>Click and drag over the 15-minute slots below to select times you are available for a match.</p>

<div class="time-selector">
    <label for="selected-date">Date:</label>
    <input type="date" id="selected-date" value="{{ today|date:'Y-m-d' }}">

    <div class="time-grid">
        {% for hour in '0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23'|split:',' %}
            {% for minute in '00,15,30,45'|split:',' %}
            <div class="time-slot" data-time="{{ hour }}:{{ minute }}">
                {{ hour }}:{{ minute }}
            </div>
            {% endfor %}
        {% endfor %}
    </div>

    {# Changed button text and onclick function name #}
    <button id="update-availability" onclick="updateMatchAvailability()">Set Selected Times as Match Available</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let isDragging = false;
    let selectedSlots = [];

    function clearSelection() {
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected-slot');
        });
        selectedSlots = [];
    }

    document.querySelectorAll('.time-slot').forEach(slot => {
        slot.addEventListener('mousedown', (e) => {
            isDragging = true;
            clearSelection();
            slot.classList.add('selected-slot');
            selectedSlots.push(slot.dataset.time);
        });

        slot.addEventListener('mouseover', (e) => {
            if (isDragging && !slot.classList.contains('selected-slot')) {
                slot.classList.add('selected-slot');
                selectedSlots.push(slot.dataset.time);
            }
        });
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    const startTimeInput = document.getElementById('start_time');
    const endTimeInput = document.getElementById('end_time');

    endTimeInput.addEventListener('change', function() {
        if(startTimeInput.value && endTimeInput.value) {
            const startTime = new Date(startTimeInput.value);
            const endTime = new Date(endTimeInput.value);

            if(endTime <= startTime) {
                alert('End time must be after start time');
                endTimeInput.value = '';
            }

            // Optional: Keep duration check or adjust if needed for match availability
            const duration = (endTime - startTime) / (1000 * 60 * 60); // in hours
            // if(duration > 2) { // Example check
            //     alert('Match availability periods cannot exceed 2 hours');
            //     endTimeInput.value = '';
            // }
        }
    });

    // Renamed global function
    window.updateMatchAvailability = function() {
        if (selectedSlots.length === 0) {
            alert("No time slots selected.");
            return;
        }

        const selectedDate = document.getElementById('selected-date').value;

        // Changed fetch URL
        fetch("/update-match-availability/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                times: selectedSlots,
                activity_type: "{{ activity_type }}",
                selected_date: selectedDate
            })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            window.location.reload();
        })
        .catch(error => console.error("Error:", error));
    };

    // Renamed global function and parameter
    window.toggleMatchAvailability = function(matchAvailabilityId, currentStatus) {
        // Changed fetch URL and parameter name
        fetch(`/toggle-match-availability/${matchAvailabilityId}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                is_available: !currentStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                window.location.reload();
            } else {
                alert(data.message || "An error occurred");
            }
        })
        .catch(error => console.error("Error:", error));
    };

    // Renamed global function and parameter
    window.deleteMatchAvailability = function(matchAvailabilityId) {
        // Changed confirmation message text
        if(confirm("Are you sure you want to delete this match availability slot?")) {
            // Changed fetch URL and parameter name
            fetch(`/delete-match-availability/${matchAvailabilityId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || "An error occurred");
                }
            })
            .catch(error => console.error("Error:", error));
        }
    };

    // Renamed function and changed URL name
    window.filterMatchAvailabilityByDate = function() {
        const selectedDate = document.getElementById('availability-date').value;
        // Changed URL name
        window.location.href = `{% url 'match_availability' activity_type=activity_type %}?date=${selectedDate}`;
    };
});
</script>

<style>
/* Styles remain the same */
.time-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 5px;
    margin: 20px 0;
}

.time-slot {
    padding: 8px;
    text-align: center;
    border: 1px solid #ddd;
    cursor: pointer;
    background-color: #f9f9f9;
}

.time-slot:hover {
    background-color: #e9f7ff;
}

.time-slot.selected-slot {
    background-color: #cce5ff;
    border-color: #007bff;
}

.error-message {
    color: red;
    padding: 10px;
    margin: 10px 0;
    background-color: #ffeeee;
    border: 1px solid #ffcccc;
    border-radius: 4px;
}

.date-selector {
    margin: 15px 0;
}
</style>
{% endblock %}