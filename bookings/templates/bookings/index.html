{% extends "base.html" %}

{% block title %}BookMe - Timetable{% endblock %}

{% block content %}
    <h2>Timetable (15-Minute Slots)</h2>

    {# --- Date Selector (Keep as is) --- #}
    <div class="date-selector" style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"> {# Use flexbox for alignment #}
        {# Previous Day Button #}
        <a href="{% url 'index' %}?date={{ previous_date }}" class="button date-nav-button">&lt; Prev</a>

        {# Date Input #}
        <div> {# Wrap label and input for better control if needed #}
            <label for="selected-date" style="margin-right: 5px;">Select Date:</label>
            <input type="date" id="selected-date" value="{{ selected_date|date:'Y-m-d' }}" onchange="changeDate()">
        </div>

        {# Today Button #}
        {# Only show Today button if selected date is not today #}
        {% if selected_date|date:'Y-m-d' != today_date %}
            <a href="{% url 'index' %}?date={{ today_date }}" class="button date-nav-button">Today</a>
        {% endif %}

        {# Next Day Button #}
        <a href="{% url 'index' %}?date={{ next_date }}" class="button date-nav-button">Next &gt;</a>
    </div>

    {# --- NEW: Tab Navigation --- #}
    <div class="tab-navigation">
        {# Add 'active' class to the default tab link #}
        <button class="tab-link active" data-target="pool-pane">Pool</button>
        <button class="tab-link" data-target="switch-pane">Nintendo Switch</button>
        <button class="tab-link" data-target="table_tennis-pane">Table Tennis</button>
        {# Optional: Add "My Schedule" tab here later #}
    </div>

    {# --- NEW: Tab Content Panes --- #}
    <div class="tab-content">
        {# Loop through activities provided by the view context #}
        {% for activity, slots in timetable_by_activity.items %}
            {# Apply 'active' class directly based on comparison #}
            <div id="{{ activity }}-pane" class="tab-pane{% if activity == 'pool' %} active{% endif %}"> {# <--- CORRECTED LINE #}
                {# Keep the existing table structure inside the pane #}
                <h3>
                    {% if activity == "pool" %}Pool
                    {% elif activity == "switch" %}Nintendo Switch
                    {% elif activity == "table_tennis" %}Table Tennis
                    {% endif %}
                </h3>
                <div class="table-wrapper"> {# Add wrapper for potential horizontal scroll #}
                    <table class="timetable">
                        <thead>
                            <tr>
                                <th>Time Slot</th>
                                <th>Status</th>
                                <th>Booked By / Comp Details</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for slot in slots %}
                            <tr class="{% if slot.type == 'available' %}clickable{% elif slot.type == 'competition' %}competition-slot{% endif %}"
                                data-time="{{ slot.time_slot }}" data-date="{{ selected_date }}" data-activity="{{ activity }}">

                                <td>{{ slot.time_slot }}</td>
                                <td {% if slot.type == "booked" %} style="color: red;"
                                    {% elif slot.type == "competition" %} style="color: blue;"
                                    {% else %} style="color: green;" {% endif %}>
                                    {{ slot.status }}
                                </td>
                                <td>
                                    {% if slot.type == 'competition' %}
                                         <small>By: {{ slot.name|default:'-' }} ({{ slot.details }})</small>
                                    {% else %}
                                        {{ slot.name|default:"-" }}
                                    {% endif %}
                                </td>
                                <td>
                                    {# Action logic remains the same as before #}
                                    {% if slot.type == "booked" and slot.booked_by_user %}
                                        <button onclick="cancelBooking('{{ slot.booking_id }}', '{{ slot.user_id }}')">Cancel Booking</button>
                                    {% elif slot.type == "competition" %}
                                        <a href="{% url 'competition_detail' competition_id=slot.competition_id %}" class="button button-small button-info">Details</a>
                                        {% if user.is_authenticated %}
                                            {% if slot.is_creator %}
                                                <span style="color: gray; font-weight: bold; margin-left: 5px;">Creator</span>
                                            {% elif slot.user_joined %}
                                                <button onclick="leaveCompetition('{{ slot.competition_id }}')" class="button button-small button-danger" style="margin-left: 5px;">Leave</button> {# Added class #}
                                            {% elif slot.can_join_competition %}
                                                <button onclick="joinCompetition('{{ slot.competition_id }}')" class="button button-small button-success" style="margin-left: 5px;">Join</button> {# Added class #}
                                            {% elif slot.is_full %}
                                                <span style="color: orange; font-weight: bold; margin-left: 5px;">Full</span>
                                            {% else %}
                                                <span style="color: gray; margin-left: 5px;">Unavailable</span>
                                            {% endif %}
                                        {% else %}
                                             <span style="margin-left: 5px;"><a href="{% url 'login' %}?next={{ request.path }}">Login to Join/View</a></span>
                                        {% endif %}
                                    {% elif slot.type == "available" %}
                                        {% if user.is_authenticated %}
                                            <button onclick="openBookingForm('{{ slot.time_slot }}', '{{ selected_date|date:'Y-m-d' }}', '{{ activity }}')">Book</button>
                                        {% else %}
                                            <p><a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to book.</p>
                                        {% endif %}
                                    {% else %}
                                     -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> {# End table-wrapper #}
            </div> {# End tab-pane #}
            {# No need for {% endwith %} here anymore #}
        {% endfor %}
    </div> {# End tab-content #}

    {# --- Booking Modal (Keep as is) --- #}
    {% if user.is_authenticated %}
    <div id="booking-overlay" class="overlay" style="display: none;">
        <div class="overlay-content">
            <span class="close" onclick="closeBookingForm()">&times;</span>
            <h2>Book Time Slot</h2>
            <form id="booking-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="selected-date-display">Selected Date:</label>
                    <input type="text" id="selected-date-display" name="booking_date" readonly>
                </div>
                <div class="form-group">
                    <label for="selected-time">Selected Time:</label>
                    <input type="text" id="selected-time" name="start_time" readonly>
                </div>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" value="{{ user.username }}" readonly>
                </div>
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" value="{{ user.username }}" readonly>
                </div>
                <div class="form-group">
                    <label for="booking_type">Activity:</label>
                    <input type="text" id="booking_type" name="booking_type" readonly>
                </div>
                <button type="submit">Book Slot</button>
            </form>
        </div>
    </div>
    {% endif %}

    {# --- JavaScript for Tabs and other functions (Keep existing JS, add tab logic) --- #}
    <script>
        // --- Existing Functions (Keep these) ---
        function changeDate() {
            let selectedDate = document.getElementById("selected-date").value;
            window.location.href = "?date=" + selectedDate;
        }

        function openBookingForm(timeSlot, dateSlot, activity) {
            document.getElementById("selected-time").value = timeSlot;
            document.getElementById("selected-date-display").value = dateSlot;
            document.getElementById("booking_type").value = activity;
            document.getElementById("booking-overlay").style.display = "flex";
        }

        function closeBookingForm() {
            document.getElementById("booking-overlay").style.display = "none";
        }

        const bookingForm = document.getElementById("booking-form");
        if (bookingForm) {
            bookingForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const formData = new FormData(this);
                let bookingData = {};
                formData.forEach((value, key) => bookingData[key] = value);

                fetch("{% url 'api_book' %}", { // Ensure CSRF token is handled if needed
                    method: "POST",
                    headers: {
                        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(bookingData)
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if(data.message.includes("created")) {
                         closeBookingForm();
                         location.reload();
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("An error occurred during booking.");
                });
            });
        }

        function cancelBooking(bookingId, userId) { // Ensure userId is passed if needed by view logic
             if (!confirm("Are you sure you want to cancel this booking?")) return;
            fetch(`/cancel/${bookingId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                 if(data.message.includes("cancelled")) {
                     location.reload();
                 }
            })
            .catch(error => {
                 console.error("Error:", error);
                 alert("An error occurred cancelling the booking.");
            });
        }

        function leaveCompetition(competitionId) {
             if (!confirm("Are you sure you want to leave this competition?")) return;
            fetch(`/leave-competition/${competitionId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                    "Content-Type": "application/json"
                },
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if(data.success) {
                    location.reload();
                }
            })
            .catch(error => {
                console.error("Error leaving competition:", error);
                alert("An error occurred while trying to leave the competition.");
            });
        }

        function joinCompetition(competitionId) {
            if (!confirm("Are you sure you want to join this competition?")) return;
            fetch(`/join-competition/${competitionId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
                    "Content-Type": "application/json"
                },
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if(data.success) {
                    location.reload();
                }
            })
            .catch(error => {
                console.error("Error joining competition:", error);
                alert("An error occurred while trying to join the competition.");
            });
        }

        // --- NEW: JavaScript for Tab Switching ---
        document.addEventListener('DOMContentLoaded', function() {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabPanes = document.querySelectorAll('.tab-pane');

            tabLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const targetPaneId = this.getAttribute('data-target');

                    // Remove active class from all links and panes
                    tabLinks.forEach(l => l.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.remove('active'));

                    // Add active class to the clicked link and target pane
                    this.classList.add('active');
                    const targetPane = document.getElementById(targetPaneId);
                    if (targetPane) {
                        targetPane.classList.add('active');
                    }
                });
            });
        });
        // --- End Tab JS ---

    </script>

{% endblock %}